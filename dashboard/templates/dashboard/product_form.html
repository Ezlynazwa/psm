{% extends "dashboard/adminbase.html" %}
{% load static %}
{% block title %}{{ action }} Product | Brew Beauty{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product_form.css' %}">
{% endblock %}

{% block content %}
<div class="product-form-container">
    <div class="form-header">
        <h2><i class="fas fa-makeup-brush"></i> {{ action }} Makeup Product</h2>
        <p>Fill in the makeup product details below</p>
    </div>

    <form method="post" enctype="multipart/form-data" class="product-form">
        {% csrf_token %}
        
        <!-- Section 1: Basic Product Info -->
        <div class="form-section">
            <h3><i class="fas fa-info-circle"></i> Product Information</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.brand.id_for_label }}">Brand*</label>
                    {{ form.brand }}
                </div>
                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}">Product Name*</label>
                    {{ form.name }}
                </div>
                <div class="form-group">
                    <label for="{{ form.category.id_for_label }}">Category*</label>
                    {{ form.category }}
                </div>
                <div class="form-group">
                    <label for="{{ form.price.id_for_label }}">Price (RM)*</label>
                    {{ form.price }}
                </div>
                <div class="form-group">
                    <label for="{{ form.size.id_for_label }}">Size*</label>
                    {{ form.size }}
                </div>
            </div>
            
            <div class="form-group full-width">
                <label for="{{ form.description.id_for_label }}">Description</label>
                {{ form.description }}
            </div>
        </div>

        <!-- Section 2: Makeup-Specific Attributes -->
        <div class="form-section">
            <h3><i class="fas fa-palette"></i> Makeup Properties</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Texture*</label>
                    {{ form.texture }}
                </div>
                <div class="form-group">
                    <label>Finish</label>
                    {{ form.finish }}
                </div>
                <div class="form-group">
                    <label>Long Lasting</label>
                    <div class="checkbox-container">
                        {{ form.long_last }}
                        <label for="{{ form.long_last.id_for_label }}" class="checkbox-label"></label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Waterproof</label>
                    <div class="checkbox-container">
                        {{ form.waterproof }}
                        <label for="{{ form.waterproof.id_for_label }}" class="checkbox-label"></label>
                    </div>
                </div>
                <div class="form-group">
                    <label>SPF </label>
                    {{ form.spf }}
                    <label for="{{ form.spf.id_for_label }}"></label>
                </div>
                <div class="form-group">
                    <label>Coverage </label>
                    {{ form.coverage }}
                    <label for="{{ form.coverage.id_for_label }}"></label>
                </div>
                <div class="form-group">
                    <label>Vegan</label>
                    <div class="checkbox-container">
                        {{ form.is_vegan }}
                        <label for="{{ form.is_vegan.id_for_label }}" class="checkbox-label"></label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Cruelty Free</label>
                    <div class="checkbox-container">
                        {{ form.is_cruelty_free }}
                        <label for="{{ form.is_cruelty_free.id_for_label }}" class="checkbox-label"></label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Product Images -->
        <div class="form-section">
            <h3><i class="fas fa-images"></i> Product Images</h3>
            <div class="image-upload-container">
                {{ formset.management_form }}
                <div class="image-grid" id="image-container">
                    {% for form in formset %}
                    <div class="image-upload-box">
                        {{ form.id }}
                        <label class="image-upload-label">
                            {{ form.image }}
                            <div class="image-preview">
                                {% if form.instance.image %}
                                    <img src="{{ form.instance.image.url }}" class="preview-image">
                                {% else %}
                                    <i class="fas fa-camera"></i>
                                    <span>Click to upload</span>
                                {% endif %} 
                            </div>
                            <button type="button" class="remove-image" onclick="removeImage(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </label>
                        {{ form.DELETE }}
                    </div>
                    {% endfor %}
                    
                    <!-- Empty form for new images -->
                    {% for i in empty_image_forms %}
                    <div class="image-upload-box">
                        <label class="image-upload-label">
                            <input type="file" name="images-{{ forloop.counter|add:formset.forms|length }}-image" 
                                   id="id_form-{{ forloop.counter|add:formset.forms|length }}-image" 
                                   accept="image/*">
                            <div class="image-preview">
                                <i class="fas fa-camera"></i>
                                <span>Click to upload</span>
                            </div>
                            <button type="button" class="remove-image" onclick="removeImage(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </label>
                        <input type="hidden" name="images-{{ forloop.counter|add:formset.forms|length }}-id" 
                               id="id_form-{{ forloop.counter|add:formset.forms|length }}-id">
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="add-image-btn" onclick="addImageInput()">
                    <i class="fas fa-plus"></i> Add Image
                </button>
            </div>
        </div>

        <!-- Section 4: Color Variations -->
        <div class="form-section">
            <h3><i class="fas fa-swatchbook"></i> Color Variations</h3>
            <div class="variation-container" id="variation-container">
        <!-- For variation formset -->
        {{ variation_formset.management_form }}    
            {% for form in variation_formset %}
                <div class="variation-item">
                    <div class="variation-header">
                        <h4>Variation #<span class="variation-number">{{ forloop.counter }}</span></h4>
                        <button type="button" class="remove-variation" onclick="removeVariation(this)">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ form.variation_code.id_for_label }}">Shade Code*</label>
                            {{ form.variation_code }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.quantity.id_for_label }}">Quantity*</label>
                            {{ form.quantity }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.skin_tone.id_for_label }}">Undertone</label>
                            <select name="variations-{{ forloop.counter0 }}-skin_tone" 
                                    id="id_variations-{{ forloop.counter0 }}-skin_tone" 
                                    class="form-control">
                                <option value="">Select Undertone</option>
                                {% for value, label in variation_formset.form.skin_tone.field.choices %}
                                    <option value="{{ value }}" {% if form.skin_tone.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="{{ form.surface_tones.id_for_label }}">Surface Tone</label>
                            <select name="variations-{{ forloop.counter0 }}-surface_tones" 
                                    id="id_variations-{{ forloop.counter0 }}-surface_tones" 
                                    class="form-control">
                                <option value="">Select Surface Tone</option>
                                {% for value, label in variation_formset.form.surface_tones.field.choices %}
                                    <option value="{{ value }}" {% if form.surface_tones.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {{ form.id }}
                    {{ form.DELETE }}
                </div>
                {% endfor %}
                <!-- Empty form for new variations -->
                {% for i in empty_variation_forms %}
                <div class="variation-item">
                    <div class="variation-header">
                        <h4>Variation #<span class="variation-number">{{ forloop.counter|add:variation_formset.forms|length }}</span></h4>
                        <button type="button" class="remove-variation" onclick="removeVariation(this)">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Shade Code*</label>
                            <input type="text" name="variations-{{ forloop.counter|add:variation_formset.forms|length }}-variation_code" 
                                   class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity*</label>
                            <input type="number" name="variations-{{ forloop.counter|add:variation_formset.forms|length }}-quantity" 
                                   class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Undertone</label>
                            <select name="variation_set-{{ forloop.counter|add:variation_formset.forms|length }}-skin_tone" 
                                    class="form-control">
                                <option value="">Select Undertone</option>
                                {% for value, label in form.fields.skin_tone.choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Surface Tone</label>
                            <select name="variation_set-{{ forloop.counter|add:variation_formset.forms|length }}-surface_tones" 
                                    class="form-control">
                                <option value="">Select Surface Tone</option>
                                {% for value, label in form.fields.surface_tones.choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <input type="hidden" name="variation_set-{{ forloop.counter|add:variation_formset.forms|length }}-id">
                </div>
                {% endfor %}
            </div>
            <button type="button" class="add-variation-btn" onclick="addVariation()">
                <i class="fas fa-plus"></i> Add Color Variation
            </button>
        </div>

        <!-- Section 5: Skin Compatibility -->
        <div class="form-section">
            <h3><i class="fas fa-user-circle"></i> Skin Compatibility</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.skin_type.id_for_label }}">Skin Type</label>
                    {{ form.skin_type }}
                </div>
                <div class="form-group">
                    <label for="{{ form.skin_condition.id_for_label }}">Skin Condition</label>
                    {{ form.skin_condition }}
                </div>
                <div class="form-group">
                    <label for="{{ form.skin_texture.id_for_label }}">Skin Texture</label>
                    {{ form.skin_texture }}
                </div>
                <div class="form-group">
                    <label for="{{ form.sensitivity_level.id_for_label }}">Sensitivity Level</label>
                    {{ form.sensitivity_level }}
                </div>
            </div>
        </div>

        <!-- Section 6: Inventory Management -->
        <div class="form-section">
            <h3><i class="fas fa-box-open"></i> Inventory</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.quantity.id_for_label }}">Total Quantity*</label>
                    {{ form.quantity }}
                    <small class="form-text text-muted">Auto-calculated from variations</small>
                </div>
                <div class="form-group">
                    <label for="{{ form.min_stock.id_for_label }}">Min Stock Alert</label>
                    {{ form.min_stock }}
                </div>
                <div class="form-group">
                    <label for="{{ form.max_stock.id_for_label }}">Max Stock Capacity</label>
                    {{ form.max_stock }}
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="submit-btn">
                <i class="fas fa-save"></i> {{ action }} Product
            </button>
            <a href="{% url 'dashboard:manageproducts' %}" class="cancel-btn">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
// Image Upload and Preview
document.addEventListener('DOMContentLoaded', function() {
    // Initialize image previews
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const preview = this.closest('.image-upload-label').querySelector('.image-preview');
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="preview-image">`;
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    });

    // Initialize finish selection
    document.querySelectorAll('.finish-option input').forEach(radio => {
        if (radio.checked) {
            radio.closest('.finish-option').classList.add('selected');
        }
    });
});

// Add new image input
function addImageInput() {
    const totalForms = document.getElementById('id_images-TOTAL_FORMS');
    const formCount = parseInt(totalForms.value);
    const container = document.getElementById('image-container');
    
    const newInput = document.createElement('div');
    newInput.className = 'image-upload-box';
    newInput.innerHTML = `
        <label class="image-upload-label">
            <input type="file" name="form-${formCount}-image" id="id_form-${formCount}-image" accept="image/*">
            <div class="image-preview">
                <i class="fas fa-camera"></i>
                <span>Click to upload</span>
            </div>
            <button type="button" class="remove-image" onclick="removeImage(this)">
                <i class="fas fa-times"></i>
            </button>
        </label>
        <input type="hidden" name="form-${formCount}-id" id="id_form-${formCount}-id">
    `;
    
    container.appendChild(newInput);
    totalForms.value = formCount + 1;
    
    // Add event listener for the new input
    newInput.querySelector('input[type="file"]').addEventListener('change', function(e) {
        const preview = this.closest('.image-upload-label').querySelector('.image-preview');
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" class="preview-image">`;
            }
            reader.readAsDataURL(this.files[0]);
        }
    });
}

// Remove image input
function removeImage(button) {
    const box = button.closest('.image-upload-box');
    const deleteInput = box.querySelector('input[type="checkbox"][name$="-DELETE"]');
    
    if (deleteInput) {
        // Mark for deletion if it's part of the formset
        deleteInput.checked = true;
        box.style.display = 'none';
    } else {
        // If dynamically added and not saved yet, just remove from DOM
        box.remove();

        // Update TOTAL_FORMS count
        const totalForms = document.getElementById('id_images-TOTAL_FORMS');
        const currentCount = parseInt(totalForms.value);
        totalForms.value = currentCount - 1;
    }
}


// Add new variation
function addVariation() {
    const totalForms = document.getElementById('id_variations-TOTAL_FORMS');
    const formCount = parseInt(totalForms.value);
    const container = document.getElementById('variation-container');
    
    const newVariation = document.createElement('div');
    newVariation.className = 'variation-item';
    newVariation.innerHTML = `
        <div class="variation-header">
            <h4>Variation #<span class="variation-number">${formCount + 1}</span></h4>
            <button type="button" class="remove-variation" onclick="removeVariation(this)">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label>Shade Code*</label>
                <input type="text" name="variation_set-${formCount}-variation_code" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Quantity*</label>
                <input type="number" name="variation_set-${formCount}-quantity" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="{{ form.skin_tone.id_for_label }}">Undertone</label>
                <select name="variations-{{ forloop.counter0 }}-skin_tone" 
                        id="id_variations-{{ forloop.counter0 }}-skin_tone" 
                        class="form-control">
                    <option value="">Select Undertone</option>
                    {% for value, label in variation_formset.form.skin_tone.field.choices %}
                        <option value="{{ value }}" {% if form.skin_tone.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="{{ form.surface_tones.id_for_label }}">Surface Tone</label>
                <select name="variations-{{ forloop.counter0 }}-surface_tones" 
                        id="id_variations-{{ forloop.counter0 }}-surface_tones" 
                        class="form-control">
                    <option value="">Select Surface Tone</option>
                    {% for value, label in variation_formset.form.surface_tones.field.choices %}
                        <option value="{{ value }}" {% if form.surface_tones.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <input type="hidden" name="variation_set-${formCount}-id" id="id_variation_set-${formCount}-id">
    `;
    
    container.appendChild(newVariation);
    totalForms.value = formCount + 1;
    updateVariationNumbers();
}

// Remove variation
function removeVariation(button) {
    const variationItem = button.closest('.variation-item');
    const deleteInput = variationItem.querySelector('input[name$="-DELETE"]');
    
    if (deleteInput) {
        // Mark for deletion
        deleteInput.value = 'on';
        variationItem.style.display = 'none';
    } else {
        // Just remove if it's new
        variationItem.remove();
        const totalForms = document.getElementById('id_variation_set-TOTAL_FORMS');
        totalForms.value = parseInt(totalForms.value) - 1;
    }
    
    updateVariationNumbers();
}

// Update variation numbers
function updateVariationNumbers() {
    const variations = document.querySelectorAll('.variation-item:not([style*="display: none"])');
    variations.forEach((variation, index) => {
        variation.querySelector('.variation-number').textContent = index + 1;
    });
}

// Highlight selected finish option
document.addEventListener('click', function(e) {
    if (e.target.closest('.finish-option')) {
        document.querySelectorAll('.finish-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        e.target.closest('.finish-option').classList.add('selected');
    }
});
</script>
{% endblock %}